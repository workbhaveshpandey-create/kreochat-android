rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verify the user is part of the chat's participants list
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Allow create/update only if the user is the owner
      allow create, update: if isOwner(userId);
      
      // Prevent deletion (optional, but safer)
      allow delete: if false; 
    }

    // --- Usernames Collection ---
    match /usernames/{username} {
      allow read: if isAuthenticated();
      
      // Allow reservation if authenticated and claiming for self
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      
      // Allow update if owner (unlikely needed but consistent)
      allow update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      
      allow delete: if false; 
    }

    // --- Chats Collection ---
    match /chats/{chatId} {
      // Allow read if user is a participant
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;

      // Allow create if user includes themselves as participant
      allow create: if isAuthenticated() && 
                    request.resource.data.participants.size() >= 2 &&
                    request.auth.uid in request.resource.data.participants;

      // Allow update (e.g. typing status, lastMessage) if participant
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;

      // --- Messages Subcollection ---
      match /messages/{messageId} {
        // Parent chat access logic applies via function
        function getChatData() {
           return get(/databases/$(database)/documents/chats/$(chatId)).data;
        }

        allow read: if isAuthenticated() && request.auth.uid in getChatData().participants;

        // Allow create if sender is self and part of chat
        allow create: if isAuthenticated() && 
                      request.auth.uid in getChatData().participants &&
                      request.resource.data.senderId == request.auth.uid;

        allow update: if isAuthenticated() && 
                      request.auth.uid in getChatData().participants && (
                        // Sender can edit/delete their own message
                        resource.data.senderId == request.auth.uid ||
                        // Recipients can update status, deletedFor, reactions
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deletedFor', 'reactions', 'status'])
                      );
      }
    }

    // --- Calls Collection ---
    match /calls/{callId} {
      allow read: if isAuthenticated();
      // Allow create/update if authenticated (refine if needed, e.g. only participants)
      allow create, update: if isAuthenticated();
    }
  }
}